## 3. 任务

`Task` 是 `Kairos` 中的一个关键概念，它允许在指定的时间执行特定任务。`Task` 对象提供以下方法：

-   `GetMetadata`：获取任务的元数据，包括获取任务信息的方法。
    1.  `GetID`：获取任务的 ID。
    2.  `GetName`：获取任务的名称。
    3.  `GetHandleFunc`：获取任务的处理函数。
-   `EarlyReturn`：手动停止任务执行并提前返回，无需等待超时或取消信号。它会调用 `handleFunc`。
-   `Cancel`：手动停止任务执行并立即返回，不执行 `handleFunc`。
-   `Wait`：等待任务完成，阻塞当前 goroutine 直到任务完成。

> [!NOTE]
>
> `Wait` 方法是一个阻塞方法。建议在单独的 `goroutine` 中使用它，以避免阻塞主 `goroutine`。
>
> 如果需要获取任务，可以使用 `Get` 方法通过任务的 `ID` 获取任务。一旦获取到任务，可以使用 `Wait` 方法等待任务完成。
>
> 不需要手动停止任务。任务执行后，其状态会自动在 `Scheduler` 中清除。如果需要主动删除任务，可以使用 `Delete` 方法删除相应的任务（仅在必要时才应该这样做，不推荐）。

## 4. 示例

示例代码位于 `examples` 目录中。

```go
package main

import (
	"fmt"
	"time"

	ks "github.com/shengyanli1982/kairos"
)

// demoSchedCallback 结构体实现了调度器的回调接口。
// The demoSchedCallback struct implements the callback interface of the scheduler.
type demoSchedCallback struct{}

// OnTaskExecuted 是一个方法，当任务执行后会被调用。
// OnTaskExecuted is a method that is called after a task is executed.
func (tc *demoSchedCallback) OnTaskExecuted(id, name string, data any, reason, err error) {
	// 打印任务执行后的信息。
	// Print the information after the task is executed.
	fmt.Printf("# [CALLBACK] Task executed, id: %s, name: %s, data: %v, reason: %v, err: %v\n", id, name, data, reason, err)
}

// OnTaskAdded 是一个方法，当任务被添加时会被调用。
// OnTaskAdded is a method that is called when a task is added.
func (tc *demoSchedCallback) OnTaskAdded(id, name string, execAt time.Time) {
	// 打印任务添加的信息。
	// Print the information when the task is added.
	fmt.Printf("# [CALLBACK] Task added, id: %s, name: %s, execAt: %s\n", id, name, execAt.String())
}

// OnTaskRemoved 是一个方法，当任务被删除时会被调用。
// OnTaskRemoved is a method that is called when a task is removed.
func (tc *demoSchedCallback) OnTaskRemoved(id, name string) {
	// 打印任务删除的信息。
	// Print the information when the task is removed.
	fmt.Printf("# [CALLBACK] Task removed, id: %s, name: %s\n", id, name)
}

// main 是程序的入口点。
// main is the entry point of the program.
func main() {
	// 创建一个新的配置，并设置回调函数。
	// Create a new configuration and set the callback function.
	config := ks.NewConfig().WithCallback(&demoSchedCallback{})

	// 使用配置创建一个新的调度器。
	// Create a new scheduler with the configuration.
	scheduler := ks.New(config)

	// 循环添加 10 个任务到调度器。
	// Loop to add 10 tasks to the scheduler.
	for i := 0; i < 10; i++ {
		// 保存当前的索引值。
		// Save the current index value.
		index := i

		// taskName 是任务的名称，通过格式化字符串生成
		// taskName is the name of the task, generated by formatting a string
		taskName := fmt.Sprintf("test_task_%d", index)

		// 添加一个新的任务到调度器，并获取任务的 ID。
		// Add a new task to the scheduler and get the ID of the task.
		taskID := scheduler.Set(taskName, func(done ks.WaitForContextDone) (result any, err error) {

			// 当任务完成时，返回任务的名称
			// When the task is done, return the name of the task
			for range done {
				return taskName, nil
			}

			// 如果任务没有完成，返回 nil。
			// If the task is not done, return nil.
			return nil, nil

			// 设置任务的延迟时间为 200 毫秒。
			// Set the delay time of the task to 200 milliseconds.
		}, time.Millisecond*200)

		// 获取任务。
		// Get the task.
		task := scheduler.Get(taskID)

		// 打印任务添加的信息。
		// Print the information when the task is added.
		fmt.Printf("%% [MAIN] Task %d can be retrieved, id: %s, name: %s\n", index, task.GetMetadata().GetID(), task.GetMetadata().GetName())
	}

	// 等待一段时间，让任务有机会执行。
	// Wait for a while to give the tasks a chance to execute.
	time.Sleep(time.Millisecond * 500)

	// 停止调度器，停止所有的任务。
	// Stop the scheduler, stop all tasks.
	scheduler.Stop()
}
```

**执行结果**

```bash
$ go run demo.go
# [CALLBACK] Task added, id: 63f053cf-5da8-4070-802c-2d9c9f493c23, name: test_task_0, execAt: 2024-03-29 22:14:20.347086 +0800 CST m=+0.200244340
% [MAIN] Task 0 can be retrieved, id: 63f053cf-5da8-4070-802c-2d9c9f493c23, name: test_task_0
# [CALLBACK] Task added, id: 3006c080-ac62-4523-9ff7-a7d21b5d6e23, name: test_task_1, execAt: 2024-03-29 22:14:20.347357 +0800 CST m=+0.200515252
% [MAIN] Task 1 can be retrieved, id: 3006c080-ac62-4523-9ff7-a7d21b5d6e23, name: test_task_1
# [CALLBACK] Task added, id: 585408bd-1f31-433e-be4b-a7f03e4ccb58, name: test_task_2, execAt: 2024-03-29 22:14:20.347379 +0800 CST m=+0.200536895
% [MAIN] Task 2 can be retrieved, id: 585408bd-1f31-433e-be4b-a7f03e4ccb58, name: test_task_2
# [CALLBACK] Task added, id: 6ea38719-503e-4fce-9155-03280a818c0d, name: test_task_3, execAt: 2024-03-29 22:14:20.347391 +0800 CST m=+0.200548818
% [MAIN] Task 3 can be retrieved, id: 6ea38719-503e-4fce-9155-03280a818c0d, name: test_task_3
# [CALLBACK] Task added, id: 8d7a4d5e-27b9-47c7-b307-445e84e8fa79, name: test_task_4, execAt: 2024-03-29 22:14:20.34741 +0800 CST m=+0.200567656
% [MAIN] Task 4 can be retrieved, id: 8d7a4d5e-27b9-47c7-b307-445e84e8fa79, name: test_task_4
# [CALLBACK] Task added, id: 0ebb9759-18ea-4476-8b78-d1840a547ef2, name: test_task_5, execAt: 2024-03-29 22:14:20.347428 +0800 CST m=+0.200586399
% [MAIN] Task 5 can be retrieved, id: 0ebb9759-18ea-4476-8b78-d1840a547ef2, name: test_task_5
# [CALLBACK] Task added, id: 8234e5a4-e06d-4bc6-8642-949ae86ac2e6, name: test_task_6, execAt: 2024-03-29 22:14:20.347439 +0800 CST m=+0.200597544
% [MAIN] Task 6 can be retrieved, id: 8234e5a4-e06d-4bc6-8642-949ae86ac2e6, name: test_task_6
# [CALLBACK] Task added, id: 8c2f8b22-3fd6-4aff-97b2-07c6b18aeb43, name: test_task_7, execAt: 2024-03-29 22:14:20.34745 +0800 CST m=+0.200607930
% [MAIN] Task 7 can be retrieved, id: 8c2f8b22-3fd6-4aff-97b2-07c6b18aeb43, name: test_task_7
# [CALLBACK] Task added, id: c3758e02-7cd5-45ce-8618-d83a3843c5a1, name: test_task_8, execAt: 2024-03-29 22:14:20.34746 +0800 CST m=+0.200618501
% [MAIN] Task 8 can be retrieved, id: c3758e02-7cd5-45ce-8618-d83a3843c5a1, name: test_task_8
# [CALLBACK] Task added, id: a7f95604-fe2b-46b1-a762-44b69228ed43, name: test_task_9, execAt: 2024-03-29 22:14:20.34749 +0800 CST m=+0.200648064
% [MAIN] Task 9 can be retrieved, id: a7f95604-fe2b-46b1-a762-44b69228ed43, name: test_task_9
# [CALLBACK] Task executed, id: 8d7a4d5e-27b9-47c7-b307-445e84e8fa79, name: test_task_4, data: <nil>, reason: task timeout, err: <nil>
# [CALLBACK] Task executed, id: 3006c080-ac62-4523-9ff7-a7d21b5d6e23, name: test_task_1, data: <nil>, reason: task timeout, err: <nil>
# [CALLBACK] Task removed, id: 8d7a4d5e-27b9-47c7-b307-445e84e8fa79, name: test_task_4
# [CALLBACK] Task removed, id: 3006c080-ac62-4523-9ff7-a7d21b5d6e23, name: test_task_1
# [CALLBACK] Task executed, id: 63f053cf-5da8-4070-802c-2d9c9f493c23, name: test_task_0, data: <nil>, reason: task timeout, err: <nil>
# [CALLBACK] Task executed, id: 0ebb9759-18ea-4476-8b78-d1840a547ef2, name: test_task_5, data: <nil>, reason: task timeout, err: <nil>
# [CALLBACK] Task removed, id: 0ebb9759-18ea-4476-8b78-d1840a547ef2, name: test_task_5
# [CALLBACK] Task executed, id: 8c2f8b22-3fd6-4aff-97b2-07c6b18aeb43, name: test_task_7, data: <nil>, reason: task timeout, err: <nil>
# [CALLBACK] Task removed, id: 8c2f8b22-3fd6-4aff-97b2-07c6b18aeb43, name: test_task_7
# [CALLBACK] Task executed, id: a7f95604-fe2b-46b1-a762-44b69228ed43, name: test_task_9, data: <nil>, reason: task timeout, err: <nil>
# [CALLBACK] Task removed, id: a7f95604-fe2b-46b1-a762-44b69228ed43, name: test_task_9
# [CALLBACK] Task executed, id: 585408bd-1f31-433e-be4b-a7f03e4ccb58, name: test_task_2, data: <nil>, reason: task timeout, err: <nil>
# [CALLBACK] Task executed, id: c3758e02-7cd5-45ce-8618-d83a3843c5a1, name: test_task_8, data: <nil>, reason: task timeout, err: <nil>
# [CALLBACK] Task executed, id: 8234e5a4-e06d-4bc6-8642-949ae86ac2e6, name: test_task_6, data: <nil>, reason: task timeout, err: <nil>
# [CALLBACK] Task removed, id: 8234e5a4-e06d-4bc6-8642-949ae86ac2e6, name: test_task_6
# [CALLBACK] Task removed, id: 585408bd-1f31-433e-be4b-a7f03e4ccb58, name: test_task_2
# [CALLBACK] Task removed, id: c3758e02-7cd5-45ce-8618-d83a3843c5a1, name: test_task_8
# [CALLBACK] Task removed, id: 63f053cf-5da8-4070-802c-2d9c9f493c23, name: test_task_0
# [CALLBACK] Task executed, id: 6ea38719-503e-4fce-9155-03280a818c0d, name: test_task_3, data: <nil>, reason: task timeout, err: <nil>
# [CALLBACK] Task removed, id: 6ea38719-503e-4fce-9155-03280a818c0d, name: test_task_3
```
